@using WebApp.Library.Extensions
@using Orvosi.Shared.Enums
@model IEnumerable<Orvosi.Shared.Model.DayFolder>
@{
    Layout = "~/Views/Accounting/_Layout.cshtml";

    var roleId = User.Identity.GetRoleId();
}

@foreach (var dayFolder in Model)
{
    <div class="row o-th" style="background-color: aliceblue">
        <div class="col-md-12">
            <div class="h3">
                @dayFolder.DayFormatted_MMMdd<span class="small"> @dayFolder.DayFormatted_dddd</span>
            </div>
            @if (dayFolder.Address != null)
            {
                <div class="h4">
                    @dayFolder.Address.Name
                </div>
                <div class="small" style="padding-bottom:20px;">
                    @dayFolder.Address.City
                </div>
            }
        </div>
    </div>
    <div class="row o-dashboard-tr">
        <strong class="col-md-2 o-dashboard-td">Case</strong>
        <strong class="col-md-1 o-dashboard-td">Invoice</strong>
        <strong class="col-md-1 o-dashboard-td" style="text-align: right;">Item</strong>
        <strong class="col-md-1 o-dashboard-td" style="text-align: right;">SubTotal</strong>
        <strong class="col-md-1 o-dashboard-td" style="text-align: right;">Hst</strong>
        <strong class="col-md-1 o-dashboard-td" style="text-align: right;">Total</strong>
        <strong class="col-md-3 o-dashboard-td" style="text-align: center;">Invoice Sent</strong>
        <strong class="col-md-1 o-dashboard-td" style="text-align: center;">Edit</strong>
    </div>
    <div>
        @foreach (var assessment in dayFolder.ServiceRequests)
        {
            <div class="row o-dashboard-tr">
                <div class="col-md-2 o-dashboard-td">
                    <div><strong>@assessment.ClaimantName</strong> (<a target="_blank" class="small" href="~/ServiceRequest/Details/@assessment.Id">@assessment.Id</a>)</div>
                    <strong style="color: @assessment.Service.ColorCode;">@assessment.Service.Code</strong>
                    -
                    <span>@assessment.Company.Name</span>
                    <div>
                        @(assessment.AppointmentDate.HasValue ? assessment.AppointmentDate.ToOrvosiDateFormat() : assessment.DueDate.ToOrvosiDateFormat()) @assessment.StartTime.ToShortTimeSafe()
                    </div>
                </div>
                @if (assessment.InvoiceDetails.Count() == 0)
                {
                    <div class="col-md-5 o-dashboard-td">
                        <form action="~/Invoice/Create" method="post" class="form-horizontal">
                            @Html.Hidden("Id", assessment.Id)
                            <div class="form-group">
                                <label class="control-label col-md-2" style="text-align:left;">Catalogue Price</label>
                                <div class="col-md-2"><input class="form-control input-sm" type="text" name="Price" value="@assessment.ServiceCataloguePrice" placeholder="Override Price" /></div>
                            </div>
                            @if (assessment.IsNoShow)
                            {
                                <div class="form-group">
                                    <label class="control-label col-md-2" style="text-align:left;">No Show Rate</label>
                                    <div class="col-md-2">
                                        <input class="form-control input-sm" type="text" name="NoShowRate" value="@assessment.NoShowRate" placeholder="Override Rate" />
                                    </div>
                                </div>
                            }
                            else if (assessment.IsLateCancellation)
                            {
                                <div class="form-group">
                                    <label class="control-label col-md-2" style="text-align:left;">Late Cancellation Rate</label>
                                    <div class="col-md-2"><input class="form-control input-sm" type="text" name="LateCancellationRate" value="@assessment.LateCancellationRate" placeholder="Override Rate" /></div>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(assessment.Notes))
                            {
                                <div class="text-danger form-group">
                                    <i class="fa fa-exclamation"></i> @assessment.Notes
                                </div>
                            }
                            <div class="form-group">
                                <input type="submit" class="btn btn-danger col-md-4" name="Create" value="Add Invoice" />
                            </div>
                        </form>
                    </div>
                }
                else
                {
                    foreach (var detail in assessment.InvoiceDetails)
                    {
                        <div class="col-md-1 o-dashboard-td">
                            <strong>@detail.Invoice.InvoiceNumber</strong>
                            <div>@detail.Invoice.InvoiceDate.ToOrvosiDateFormat()</div>
                        </div>
                        <div class="col-md-1 o-dashboard-td" style="text-align: right;">
                            @if (assessment.IsNoShow || assessment.IsLateCancellation)
                            {
                                <span>
                                    @string.Format("{0} of {1}", detail.Rate.ToString("0%"), detail.Amount.ToString("C2"))
                                </span>
                                if (assessment.ServiceStatusId.HasValue)
                                {
                                    <div>
                                        @Html.Partial("_ServiceStatusLabel", assessment.ServiceStatusId.Value)
                                    </div>
                                }
                            }
                            else
                            {
                                <span>
                                    @detail.Amount.ToString("C2")
                                </span>
                            }
                        </div>
                        <div class="col-md-1 o-dashboard-td" style="text-align: right;">
                            @detail.Invoice.SubTotal.Value.ToString("C2")
                        </div>
                        <div class="col-md-1 o-dashboard-td" style="text-align: right;">
                            <span class="small text-muted">(@detail.Invoice.TaxRateHst.Value.ToString("0%"))</span>
                            <span>@detail.Invoice.Hst.Value.ToString("C2")</span>
                        </div>
                        <div class="col-md-1 o-dashboard-td" style="text-align: right;">
                            <div>
                                @detail.Invoice.Total.Value.ToString("C2")
                            </div>
                        </div>
                        if (detail.Invoice.SentDate.HasValue)
                        {
                            <div class="col-md-3 o-dashboard-td" style="text-align: center;">
                                <div>
                                    <i class="fa fa-check fa-3x" style="color:green;"></i>
                                </div>
                                <div>Sent @detail.Invoice.SentDate.ToOrvosiDateTimeFormat()</div>
                            </div>
                        }
                        else
                        {
                            <div class="col-md-3 o-dashboard-td" style="text-align: center;">
                                <div>
                                    <button class="btn btn-primary" onclick="onSend(this, @detail.Invoice.Id)"><i class="fa fa-send"></i> Send</button>
                                </div>
                                <div class="help-block small">
                                    To: <strong>@detail.Invoice.Customer.BillingEmail</strong>
                                </div>
                            </div>
                        }
                        <div class="col-md-1 o-dashboard-td" style="text-align: center;">
                            <button class="btn btn-default" style="border: none;" onclick="onEdit(@detail.Id)">
                                <i class="fa fa-pencil fa-lg"></i>
                            </button>
                        </div>
                    }
                }
            </div>
        }
    </div>
}

<div class="modal fade" id="edit-modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="edit-invoicedetail-form">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="edit-modal-title">Invoice <span id="InvoiceNumber"></span> for <span id="ClaimantName"></span></h4>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="Id" name="Id" />
                    <div class="form-group">
                        <label class="control-label">Invoice Date</label>
                        <div class="input-group date" style="width:100%" id="InvoiceDatePicker">
                            <input class="form-control" size="16" type="text" name="InvoiceDate" id="InvoiceDate">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label">Amount</label>
                        <input type="text" class="form-control" id="Amount" name="Amount" />
                    </div>
                    <div class="form-group">
                        <label class="control-label">Rate</label>
                        <input type="text" class="form-control" id="Rate" name="Rate" />
                        <div class="help-block">Less than 1 will be applied as a percentage. Greater than 1, the rate will override the amount.</div>
                    </div>

                </div>
                <div class="modal-footer">
                    <input class="btn btn-success" type="submit" id="edit-modal-save" value="Save" />
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script type="text/javascript">
        $(function () {

            $('#InvoiceDatePicker').datepicker({
                format: 'yyyy-mm-dd',
                autoclose: true
            });
        });

            function onSend(el, invoiceId) {
                alert(invoiceId);
            }

            function onEdit(invoiceDetailId) {
                $.ajax({
                    type: "GET",
                    url: '@Url.Content("~/Accounting/Edit?invoiceDetailId=")' + invoiceDetailId,
                    contentType: "application/json; charset=utf-8",
                    success: function (result) {

                        var modalDiv = $("#edit-modal");
                        modalDiv.find('#InvoiceNumber').html(result.InvoiceNumber);
                        modalDiv.find('#ClaimantName').html(result.ClaimantName);

                        var form = $('#edit-invoicedetail-form');
                        form.find('#Id').val(result.Id);
                        $('#InvoiceDatePicker').datepicker('setDate', result.InvoiceDate);
                        form.find('#Amount').val(result.Amount);
                        form.find('#Rate').val(result.Rate);

                        modalDiv.modal('toggle');
                    },
                    error: function (err) {
                        alert(err.status + " - " + err.statusText);
                    }
                }, this);
            }

            $("#edit-invoicedetail-form").submit(function (e) {

                var url = '@Url.Content("~/Accounting/Update")';

                $.ajax({
                    type: "POST",
                    url: url,
                    data: $("#edit-invoicedetail-form").serialize(), // serializes the form's elements.
                    success: function (data) {
                        alert(data); // show response from the php script.
                        refreshInvoice(e, data);
                    }
                });

                e.preventDefault(); // avoid to execute the actual submit of the form.
            });

            function refreshInvoice(el, invoiceId) {

                $.ajax({
                    type: "POST",
                    url: '@Url.Content("~/Accounting/Get")',
                    data: JSON.stringify({
                        serviceProviderId: '@ViewBag.SelectedUserId',
                        serviceRequestId: invoiceId
                    }),
                    contentType: "application/json; charset=utf-8",
                    success: function (result) {
                        alert(result);
                        toastr.success("Task updated successfully.", "Task Updated");
                    },
                    error: function (err) {
                        // undo the UI change made before the ajax call
                        toastr.success("Task was not updated.", "Something went wrong!");
                    }
                }, this);

            }
    </script>
}