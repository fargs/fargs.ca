@using Model
@using Model.Enums
@model WebApp.ViewModels.ServiceRequestViewModels.IndexViewModel

@{
    ViewBag.Title = "Service Requests";

    var db = new OrvosiEntities();

    ViewBag.ServiceRequestStatuses = db.LookupItems
        .Where(l => l.LookupId == Lookups.ServiceRequestStatus)
        .Select(c => new SelectListItem()
        {
            Text = c.ItemText,
            Value = c.ItemId.ToString()
        })
        .ToList();

    ViewBag.Physicians = db.Physicians
        .Select(c => new SelectListItem()
        {
            Text = c.DisplayName,
            Value = c.Id.ToString()
        }).ToList();

    ViewBag.Staff = db.Users
        .Select(c => new SelectListItem()
        {
            Text = c.DisplayName,
            Value = c.Id.ToString(),

        }).ToList();
}

<h2>Examinations</h2>

<div class="row">
    <div class="col-md-2">
        @if (User.IsInRole("Super Admin") || User.IsInRole("Case Coordinator"))
        {
            <p>
                <a class="btn btn-primary" href="~/ServiceRequest/Availability">Book an Exam</a>
            </p>
        }
        <div class="well well-sm">
            <form action="@Url.Content("~/ServiceRequest/Index")" method="get">
                @*<div class="input-group">
                        <input type="text" class="form-control" name="Search" value="" placeholder="Search for ..." />
                        <span class="input-group-btn">
                            <button class="btn btn-default" type="button"><i class="glyphicon glyphicon-search"></i></button>
                        </span>
                    </div>*@
                <div class="form-group form-group-sm">
                    <label class="control-label small">Claimant / Reference Id</label>
                    <input type="text" class="form-control" name="FilterArgs.ClaimantName" value="@Model.FilterArgs.ClaimantName" />
                </div>
                <div class="form-group form-group-sm">
                    <label class="control-label small">Next Task</label>
                    @Html.DropDownList("FilterArgs.NextTask", new SelectList(ViewBag.Staff, "Value", "Text", Model.FilterArgs.NextTask), string.Empty, new { @class = "form-control" })
                </div>
                <div class="form-group form-group-sm">
                    <label class="control-label small">Id(s) (csv)</label>
                    <input type="text" class="form-control" name="FilterArgs.Ids" value="@Model.FilterArgs.Ids" />
                </div>
                <div class="form-group form-group-sm">
                    <label class="control-label small">Status</label>
                    @Html.DropDownList("FilterArgs.StatusId", new SelectList(ViewBag.ServiceRequestStatuses, "Value", "Text", Model.FilterArgs.StatusId), string.Empty, new { @class = "form-control" })
                </div>
                <div class="form-group form-group-sm">
                    <label class="control-label small">Date Range</label>
                    <select class="form-control" name="FilterArgs.DateRange">
                        <option></option>
                        <option value="@DateRanges.Today" @(Model.FilterArgs.DateRange == DateRanges.Today ? "selected" : string.Empty)>Today</option>
                        <option value="@DateRanges.Next10Days" @(Model.FilterArgs.DateRange == DateRanges.Next10Days ? "selected" : string.Empty)>Next 10 Days</option>
                    </select>
                </div>
                <div class="form-group form-group-sm">
                    <label class="control-label small">Sort</label>
                    <select class="form-control" name="FilterArgs.Sort">
                        <option value="Newest" @(Model.FilterArgs.Sort == "Newest" ? "selected" : string.Empty)>Newest</option>
                        <option value="Oldest" @(Model.FilterArgs.Sort == "Oldest" ? "selected" : string.Empty)>Oldest</option>
                    </select>
                </div>
                @if (Model.User.RoleCategoryId == RoleCategory.Staff || Model.User.RoleCategoryId == RoleCategory.Admin)
                {
                    <fieldset>
                        <legend class="small">Staff Only</legend>
                        <div class="form-group form-group-sm">
                            <label class="control-label small">Physician</label>
                            @Html.DropDownList("FilterArgs.PhysicianId", new SelectList(ViewBag.Physicians, "Value", "Text", Model.FilterArgs.PhysicianId), string.Empty, new { @class = "form-control" })
                        </div>
                    </fieldset>
                }
                @if (Model.User.RoleCategoryId == RoleCategory.Admin)
                {
                    <fieldset>
                        <legend class="small">Admin Only</legend>
                        <div class="form-group form-group-sm">
                            <select class="form-control" name="FilterArgs.ShowAll">
                                <option value="false" @(Model.FilterArgs.ShowAll == false ? "selected" : string.Empty)>Only Mine</option>
                                <option value="true" @(Model.FilterArgs.ShowAll == true ? "selected" : string.Empty)>Show All</option>
                            </select>
                        </div>
                    </fieldset>
                }
                <button class="btn btn-primary">Apply</button>
            </form>
        </div>
    </div>
    <div class="col-md-10">
        <table class="table">
            <tr>
                <th class="col-md-1"></th>
                <th>
                    What
                </th>
                <th>
                    Where
                </th>
                <th>
                    When
                </th>
                <th>
                    Status
                </th>
                <th>
                    Id
                </th>
            </tr>

            @foreach (var item in Model.ServiceRequests)
            {
                <tr>
                    @*<td class="@(item.StatusId == ServiceRequestStatus.Open ? "bordered-left-success" : "bordered-left-warning")">*@
                    <td class="col-md-1">
                        <div class="btn-group" style="width:100px">
                            @if (item.ServiceRequestStatusId == ServiceRequestStatus.Closed)
                            {
                                <a href="~/ServiceRequest/Details/@item.Id">View</a>
                            }
                            else
                            {
                                @Html.ActionLink("View", "Details", new { id = item.Id }, new { @class = "btn btn-default" })
                                if (Model.User.RoleCategoryId != RoleCategory.Physician)
                                {
                                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <span class="caret"></span>
                                        <span class="sr-only">Toggle Dropdown</span>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a href="~/ServiceRequest/Edit/@item.Id">Edit</a></li>
                                        <li><a href="~/ServiceRequest/ResourceAssignment/@item.Id">Resource Assignment</a></li>
                                        @if (item.ServiceStatusId != ServiceStatus.NoShow)
                                        {
                                            <li role="separator" class="divider"></li>
                                            if (item.ServiceStatusId == ServiceStatus.Cancellation || item.ServiceStatusId == ServiceStatus.LateCancellation)
                                            {
                                                <li>@Html.ActionLink("Undo Cancellation", "UndoCancel", new { id = item.Id })</li>
                                            }
                                            else
                                            {
                                                <li>@Html.ActionLink("Cancellation", "Cancel", new { id = item.Id })</li>
                                            }
                                        }
                                    </ul>
                                }
                            }
                        </div>
                    </td>
                    @if (item.ServiceRequestStatusId == ServiceRequestStatus.Closed)
                    {
                        <td colspan="4">
                            <div class="text-muted">
                                <strong>Closed</strong>
                                @item.Title
                                @if (item.ServiceStatusId == ServiceStatus.NoShow)
                                {
                                    <span class="label label-danger"><strong>No Show</strong></span>
                                }
                                else if (item.ServiceStatusId == ServiceStatus.Cancellation)
                                {
                                    <span class="label label-warning"><strong>Cancellation</strong></span>
                                }
                                else if (item.ServiceStatusId == ServiceStatus.LateCancellation)
                                {
                                    <span class="label label-danger"><strong>Late Cancellation</strong></span>
                                }
                            </div>
                        </td>
                    }
                    else
                    {
                        <td>
                            <strong>@item.ClaimantName</strong>
                            <div class="text-muted">
                                @item.CompanyName<br />
                                @item.ServiceName
                            </div>
                        </td>
                        <td>
                            <strong>@item.City</strong>
                            <div class="text-muted">@item.AddressName</div>
                        </td>
                        <td>
                            <div><strong>EXM: @item.AppointmentDate.Value.ToString("ddd, MMM dd")</strong></div>
                            <div class="text-muted" style="padding-left: 40px;">@item.AppointmentDate.Value.Add(item.StartTime.Value).ToShortTimeString()</div>
                            <div><strong>DUE: @(item.DueDate.HasValue ? item.DueDate.Value.ToString("ddd, MMM dd") : string.Empty)</strong></div>
                        </td>
                        <td>
                            <div class="label label-@(item.ServiceStatusId == ServiceStatus.Completed ? "success" : "danger")">@item.ServiceStatusText</div>
                            <div>
                                <div class="progress" style="margin-bottom: 0">
                                    <div class="progress-bar progress-bar-info" role="progressbar" aria-valuenow="@item.ClosedTasks" aria-valuemin="0" aria-valuemax="@item.TotalTasks" style="width: @(item.ClosedTasks * 100 / item.TotalTasks)%;">
                                    </div>
                                </div>
                                <small class="text-muted">@item.ClosedTasks out of @item.TotalTasks completed</small>
                            </div>
                            <div>
                                <small class="text-muted">Next Task: </small><small><strong>@item.NextTaskName</strong></small>
                            </div>
                            <div>
                                <small class="text-muted">Assigned To: <strong>@(string.IsNullOrEmpty(item.NextTaskAssignedTo) ? "<Not Assigned>" : item.NextTaskAssignedtoName)</strong></small>
                            </div>
                        </td>
                        @*<td>
                                <strong>@item.PhysicianDisplayName</strong><br />
                                @item.CaseCoordinatorName <small class="text-muted">(Case Coordinator)</small><br />
                                @item.DocumentReviewerName <small class="text-muted">(Document Reviewer)</small><br />
                                @item.IntakeAssistantName <small class="text-muted">(Intake Assistant)</small><br />
                            </td>*@
                        <td>
                            <strong>@item.Id</strong>
                        </td>
                    }
                </tr>
            }

        </table>
    </div>
</div>
