@model WebApp.ViewModels.BulkUpdateDueDateForm
<div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
    <h4 class="modal-title">
        Bulk Update Due Dates
    </h4>
</div>
<div class="modal-body">
    <form id="bulk-update-duedate-form-@Model.ServiceRequestId">
        <div>
            @foreach (var task in Model.Tasks)
            {
                <div style="display:flex; margin-bottom:5px;">
                    <div style="width:450px; margin-right:10px;">
                        @if (!task.TaskTemplateId.HasValue)
                        {
                            <i class="fa fa-asterisk text-warning"></i>
                        }
                        <span>@task.Name</span>
                    </div>
                    <div style="width:150px; margin-right:10px;">
                        <strong>@(task.DueDate.HasValue ? task.DueDate.Value.ToString("MMM dd") : "")</strong>
                    </div>
                    @*@if (task.TaskId != Tasks.AssessmentDay)
                    {*@
                        <div style="margin-right:10px;">
                            <input type="hidden" name="ServiceRequestTaskId" value="@task.Id" />
                            <input type="date" name="NewDueDate" value="@task.NewDueDate.ToOrvosiDateFormat()" />
                        </div>
                        <div style="width:100%;">
                            @if (task.DueDate.HasValue && task.NewDueDate.HasValue)
                            {
                                var totalDays = Math.Ceiling(task.NewDueDate.Value.Subtract(task.DueDate.Value).TotalDays);

                                if (totalDays < 0)
                                {
                                    <span>Actual due date is behind (<i class="fa fa-minus text-danger"></i>) expected due date by @Math.Abs(totalDays) days</span>
                                }
                                else if (totalDays == 0)
                                {
                                    <span class="text-muted">Actual due date matches expected due date</span>
                                }
                                else if (totalDays > 0)
                                {
                                    <span>Actual due date is ahead (<i class="fa fa-plus text-success"></i>) expected due date by @Math.Abs(totalDays) days</span>
                                }
                            }
                        </div>
                    @* } *@
                </div>
            }
        </div>
    </form>
</div>
<div class="modal-footer">
    <button class="btn btn-success" onclick="bulkUpdateDueDates($('#bulk-update-duedate-form-@Model.ServiceRequestId'))">Update Due Dates</button>
</div>

<script>
    function bulkUpdateDueDates(form) {
        
        let url = '@Url.Content("~/ServiceRequestTask/BulkUpdateDueDates")';

        $.post(url,
            form.serialize()
        ).done(function (data) {
            $('#modal-container').modal('toggle');
            tasklistChanged(data.serviceRequestId);
            serviceRequestStatusChanged(data.serviceRequestId);
        });
    }
</script>