@using Orvosi.Data
@using Orvosi.Shared.Enums
@using WebApp.Library.Extensions
@model WebApp.ViewModels.AvailabilityViewModels.IndexViewModel
@{
    ViewBag.Title = "Availability";

    var userContext = User.Identity.GetUserContext();

    var db = new OrvosiDbContext();

    var yearsSelectList = DateRanges.GetYears()
        .Select(c => new SelectListItem()
        {
            Text = c.Value,
            Value = c.Key.ToString()
        }).ToList();

    var monthsSelectList = DateRanges.GetMonths()
        .Select(c => new SelectListItem()
        {
            Text = c.Value,
            Value = c.Key.ToString()
        }).ToList();
}

<h2>Availability <a href="~/Availability/AddDay/@userContext.Id" class="btn btn-success"><i class="fa fa-plus"></i></a></h2>

<a href="#availability-filter" data-toggle="collapse">show/hide filter</a>
<div class="row collapse" id="availability-filter">
    <div class="col-md-12">
        <form action="~/Availability/Index/" method="get" class="form-inline">
            @Html.ValidationSummary(true, "", new { @class = "text-danger" })
            <div class="form-group">
                @Html.DropDownList("Year", new SelectList(yearsSelectList, "Value", "Text", Model.FilterArgs.Year), "-- Year --", new { @class = "form-control", onchange = "this.form.submit();" })
            </div>
            <div class="form-group">
                @Html.DropDownList("Month", new SelectList(monthsSelectList, "Value", "Text", Model.FilterArgs.Month), "-- Month --", new { @class = "form-control", onchange = "this.form.submit();" })
            </div>
        </form>
    </div>
</div>
<p></p>
@if (Model.Months.Count <= 0)
{
    <div>No available days</div>
}
@foreach (var month in Model.Months)
{
    <div class="row o-th" style="background-color: aliceblue">
        <div class="col-md-12">
            <div class="h3">
                @month.Month.ToString("yyyy MMM")
            </div>
        </div>
    </div>

    foreach (var day in month.AvailableDays.OrderBy(c => c.Day))
    {
        <div class="row o-dashboard-tr">
            <div class="col-md-2" style="padding:15px 15px">
                <div>

                    @if (day.AvailableSlots.Any() && day.AvailableSlots.All(a => a.ServiceRequests.Where(sr => !sr.CancelledDate.HasValue).Any()))
                    {
                        <div class="pull-left">@day.Day.ToString("dddd dd")<span>&nbsp;&nbsp;</span></div>
                        <i class="fa fa-check fa-lg text-success"></i>
                    }
                    else if (day.AvailableSlots.Any(a => a.ServiceRequests.Where(sr => !sr.CancelledDate.HasValue).Any()))
                    {
                        <div class="pull-left bg-warning">@day.Day.ToString("dddd dd")<span>&nbsp;&nbsp;</span></div>
                        <i class="fa fa-exclamation fa-lg text-warning"></i>
                    }
                    else
                    {
                        <form action="~/Availability/CancelDay" method="post">
                            @Html.Hidden("id", day.Id)
                            <div class="pull-left bg-danger">@day.Day.ToString("dddd dd")<span>&nbsp;&nbsp;</span></div>
                            <button type="submit" class="btn btn-link" style="padding: 0 0 0 0;"><i class="glyphicon glyphicon-remove"></i></button>
                        </form>
                    }
                </div>
                <span>
                    @if (day.LocationId == null)
                    {
                        <span class="small text-muted">No Location</span>
                    }
                    else
                    {
                        <strong class="small">@string.Format("{0} - {1}", day.Address.Name, day.Address.City)</strong>
                    }
                </span>
                <span> | </span>
                <span>
                    @if (day.CompanyId == null)
                    {
                        <span class="small text-muted">No Company</span>
                    }
                    else
                    {
                        <strong class="small">@day.Company.Name</strong>
                    }
                </span>
            </div>
            <div class="col-md-10" style="padding:15px 15px">
                <form action="~/Availability/AddSlots" method="post">
                    @Html.Hidden("AvailableDayId", day.Id)
                    <div class="bootstrap-timepicker">
                        <select name="StartHour">
                            <option value="7">7h</option>
                            <option value="8" selected>8h</option>
                            <option value="9">9h</option>
                            <option value="10">10h</option>
                            <option value="11">11h</option>
                            <option value="12">12h</option>
                            <option value="13">13h</option>
                            <option value="14">14h</option>
                            <option value="15">15h</option>
                            <option value="16">16h</option>
                            <option value="17">17h</option>
                            <option value="18">18h</option>
                            <option value="19">19h</option>
                            <option value="20">20h</option>
                            <option value="21">21h</option>
                        </select>
                        <select name="StartMinute">
                            <option value="00">00</option>
                            <option value="15">15</option>
                            <option value="30">30</option>
                            <option value="45">45</option>
                        </select>
                        <select name="Duration">
                            <option value="15">15</option>
                            <option value="30">30</option>
                            <option value="45">45</option>
                            <option value="60" selected>1h</option>
                            <option value="75">1h15</option>
                            <option value="90">1h30</option>
                            <option value="105">1h45</option>
                            <option value="120">2h</option>
                        </select>
                        <select name="Repeat">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                        <button type="submit" class="btn btn-default btn-sm">Add Slot(s)</button>
                    </div>
                </form>
                <ul class="list-inline" style="margin-bottom: 0;">
                    @foreach (var slot in day.AvailableSlots.OrderBy(c => c.StartTime))
                    {
                        <li>
                            <div class="pull-left" style="vertical-align: middle">
                                <form action="~/Availability/CancelSlot" method="post">
                                    @Html.Hidden("id", slot.Id)
                                    @if (slot.ServiceRequests.Where(sr => !sr.CancelledDate.HasValue).Any())
                                    {
                                        <a href="~/ServiceRequest/Details/@slot.ServiceRequests.First().Id" target="_blank">
                                            <div class="pull-left text-muted">@slot.StartTime.ToString(@"hh\:mm") (@slot.Duration)</div>
                                            <i class="fa fa-check fa-lg" style="color:green;"></i>
                                        </a>
                                    }
                                    else
                                    {
                                        <div class="bg-info">
                                            <div class="pull-left">
                                                <strong>@slot.StartTime.ToString(@"hh\:mm") (@slot.Duration)</strong>
                                            </div>
                                            <button type="submit" class="btn btn-link" style="padding: 0 0 0 0"><i class="glyphicon glyphicon-remove"></i></button>
                                        </div>
                                    }
                                </form>
                            </div>
                        </li>
                    }
                </ul>
            </div>
        </div>
    }
}