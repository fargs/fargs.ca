@using WebApp.Library.Extensions
@model WebApp.Views.ServiceRequestMessage.ServiceRequestMessageJSViewModel
@{
    var queryString = Newtonsoft.Json.JsonConvert.SerializeObject(Request.QueryString.ToDictionary(false));
}
<script type="text/javascript">

    let chat = null;
    $(function () {
        // Declare a proxy to reference the hub.
        chat = $.connection.serviceRequestHub;

        chat.connection.qs = @Html.Raw(queryString);

        // Create a function that the hub can call to broadcast messages.
        chat.client.addChatMessage = function (messageId, serviceRequestId) {
            appendMessage(messageId, serviceRequestId)
        };

        //$.connection.hub.logging = true;

        // Start the connection.
        $.connection.hub.start().done(function () {
            // join the rooms
            chat.server.joinRooms(@Model.ServiceRequestIds.ToJson())
        });

    });

    function joinRoom(serviceRequestId) {
        chat.server.joinRoom(serviceRequestId)
    }

    function postMessage(serviceRequestId) {

        let form = $('#service-request-message-form-' + serviceRequestId);
        let message = form.find('#Message');

        chat.server.postMessage(message.val(), serviceRequestId);

        message.val('').focus();
    }

    function onPostMessageKeyPress(e, serviceRequestId) {
        if (e.keyCode === 13) {
            e.preventDefault(); // Ensure it is only this code that runs

            postMessage(serviceRequestId);
        }
    }


    function appendMessage(messageId, serviceRequestId) {
        $.ajax({
            type: "GET",
            url: '@Url.Content("~/ServiceRequestMessage/GetMessage?serviceRequestMessageId=")' + messageId,
            contentType: "text/html",
            success: function (result) {
                var messages = $('#service-request-message-list-' + serviceRequestId);
                messages.append(result);
                var scrollDiv = $('#service-request-message-scroll-' + serviceRequestId);
                scrollDiv[0].scrollTop = scrollDiv[0].scrollHeight;
            },
            error: function (err) {
                // undo the UI change made before the ajax call
                //window.location.reload();
            }
        }, this);

    }

    function refreshDiscussion(serviceRequestId) {
        $.ajax({
            type: "GET",
            url: '@Url.Content("~/ServiceRequestMessage/Discussion?serviceRequestId=")' + serviceRequestId,
            contentType: "text/html",
            success: function (result) {
                var messages = $('#service-request-message-container-' + serviceRequestId);
                messages.replaceWith(result);
                var scrollDiv = $('#service-request-message-scroll-' + serviceRequestId);
                scrollDiv[0].scrollTop = scrollDiv[0].scrollHeight;
            },
            error: function (err) {
                // undo the UI change made before the ajax call
                //window.location.reload();
            }
        }, this);

    }

</script>
